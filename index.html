<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>Lantern Multi-Part</title>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script>
        // 場景、相機、渲染器
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 100;
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 環境光
        const ambient = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambient);

        // 黃色點光源
        const yellowLight = new THREE.PointLight(0xffff00, 10, 400);
        yellowLight.position.set(0, 0, 0);
        yellowLight.layers.set(1); 
        scene.add(yellowLight);

        // 材質設置
        const mat_zhezhou = new THREE.MeshLambertMaterial({
            color: 0xff0000,
            transparent: true,
            opacity: 0.5
        });
        const mat_diaosheng = new THREE.MeshLambertMaterial({
            color: 0x4b2e0f,
            transparent: false
        });
        const mat_liusu = new THREE.MeshPhongMaterial({
            color: 0xffd700,
            shininess: 100,
            specular: 0xffffff
        });
        const mat_yuanpan = new THREE.MeshStandardMaterial({
            color: 0x222222,
            roughness: 0.6,
            metalness: 0.3
        });
        const mat_zhuzi = new THREE.MeshPhongMaterial({
            color: 0x8b0000,
            shininess: 80,
            specular: 0xffcccc
        });
        const mat_zhuziUP = new THREE.MeshPhongMaterial({
            color: 0x8b0000,
            shininess: 80,
            specular: 0xffcccc
        });

        // 部件配置
        const parts = [
             { file: 'model/FinalProject_zhezhou.stl', material: mat_zhezhou, layer: 1 },
            { file: 'model/FinalProject_diaosheng.stl', material: mat_diaosheng, layer: 0 },
            { file: 'model/FinalProject_liusu.stl', material: mat_liusu, layer: 0 },
            { file: 'model/FinalProject_yuanpan.stl', material: mat_yuanpan, layer: 0 },
            { file: 'model/FinalProject_zhuzi.stl', material: mat_zhuzi, layer: 0 },
            { file: 'model/FinalProject_zhuziUP.stl', material: mat_zhuziUP, layer: 0 }
        ];

        // 用Group統一管理所有部件
        const group = new THREE.Group();
        scene.add(group);

        // 加載器
        const loader = new THREE.STLLoader();

        // 記錄所有mesh是否加載完成
        let loadedCount = 0;
        let meshes = [];

        // 加載所有部件
        parts.forEach((part, idx) => {
            loader.load(part.file, function (geometry) {
                const mesh = new THREE.Mesh(geometry, part.material);
                // 初始進場動畫設置
                mesh.position.set(0, 0, 10);
                mesh.scale.set(0.1, 0.1, 0.1);
                mesh.layers.set(part.layer); // 設置layer
                group.add(mesh);
                meshes[idx] = mesh;
                loadedCount++;

               // 如果是zhezhou，內部加一個發光球體
                if (part.file.includes('zhezhou')) {
                    const bulbGeometry = new THREE.SphereGeometry(2, 32, 32);
                    const bulbMaterial = new THREE.MeshBasicMaterial({
                        color: 0xffff66,
                        transparent: true,
                        opacity: 0.8,
                        emissive: 0xffff00
                    });
                    const bulb = new THREE.Mesh(bulbGeometry, bulbMaterial);
                    bulb.position.set(0, 0, 0);
                    bulb.layers.set(1); // 只在layer 1
                    mesh.add(bulb); // 加到zhezhou內部
                }
            });
        });

        // 動畫循環
        function animate() {
            requestAnimationFrame(animate);
            if (loadedCount === parts.length) {
                group.rotation.y += 0.01;
                meshes.forEach(mesh => {
                    if (mesh.position.z > 0) mesh.position.z -= 0.05;
                    if (mesh.scale.x < 1) {
                        mesh.scale.x += 0.01;
                        mesh.scale.y += 0.01;
                        mesh.scale.z += 0.01;
                    }
                });
            }
            // 先渲染layer 0（所有部件）
            camera.layers.set(0);
            renderer.render(scene, camera);
            // 再渲染layer 1（zhezhou和黃光、發光球體）
            camera.layers.set(1);
            renderer.render(scene, camera);
        }
        animate();

        // 響應式
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
